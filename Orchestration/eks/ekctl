# FARGATE PRICING
- AWS Fargate pricing is calculated based on the **vCPU and memory** resources used from the time you start to download your container image until the EKS Pod terminates.
- **Reference:** https://aws.amazon.com/fargate/pricing/    
- Amazon EKS support for AWS Fargate is available in us-east-1, us-east-2, eu-west-1, and ap-northeast-1.





5) Controller AWS Load balancer
https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html
5.1) # check IAM OIDC
aws eks describe-cluster --name <cluster_name> --query "cluster.identity.oidc.issuer" --output text
aws eks describe-cluster --name QA --query "cluster.identity.oidc.issuer" --output text
Пример вывода:
https://oidc.eks.us-west-2.amazonaws.com/id/EXAMPLED539D4633E53DE1B716D3041E
Перечислите поставщиков IAM OIDC в своей учетной записи. Заменить <EXAMPLED539D4633E53DE1B716D3041E>(включая <>) значением, возвращенным предыдущей командой.
aws iam list-open-id-connect-providers | grep <EXAMPLED539D4633E53DE1B716D3041E>
Если результат возвращается предыдущей командой, значит, у вас уже есть провайдер для вашего кластера. Если выходные данные не возвращаются, необходимо создать поставщика IAM OIDC.
5.2) Загрузите политику IAM для контроллера AWS Load Balancer Controller, которая позволяет ему выполнять вызовы API AWS от вашего имени. Вы можете просмотреть документ политикина GitHub. Используйте команду, соответствующую региону, в котором находится ваш кластер.
curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.1.0/docs/install/iam_policy.json
5.3) Создайте политику IAM, используя политику, загруженную на предыдущем шаге.
aws iam create-policy \
    --policy-name AWSLoadBalancerControllerIAMPolicy \
    --policy-document file://iam_policy.json
    
  "Policy": {
        "PolicyName": "AWSLoadBalancerControllerIAMPolicy",
        "PolicyId": "ANPAW5A7V7JN6WDOU7MYK",
        "Arn": "arn:aws:iam::<AWS_ACCOUNT_ID>:policy/AWSLoadBalancerControllerIAMPolicy",
        "Path": "/",
        "DefaultVersionId": "v1",
        "AttachmentCount": 0,
        "PermissionsBoundaryUsageCount": 0,
        "IsAttachable": true,
        "CreateDate": "2021-01-26T06:26:00+00:00",
        "UpdateDate": "2021-01-26T06:26:00+00:00"
5.4) Создайте роль IAM и аннотируйте сервисный аккаунт Kubernetes, названный aws-load-balancer-controllerв kube-system пространстве имен для AWS Load Balancer Controller, используя один из следующих вариантов.
Использование eksctl, используйте следующую команду:
  eksctl create iamserviceaccount \
  --cluster=QA \
  --namespace=kube-system \
  --name=aws-load-balancer-controller \
  --attach-policy-arn=arn:aws:iam::<AWS_ACCOUNT_ID>:policy/AWSLoadBalancerControllerIAMPolicy \
  --override-existing-serviceaccounts \
  --approve
                
<AWS_ACCOUNT_ID> - можно взять из 5.3 в строчке Arn
<AWSLoadBalancerControllerIAMPolicy> - в строчке 5.3 Arn

5.5) check existing AWS ALB ingress controller, need delete it.
kubectl get deployment -n kube-system alb-ingress-controller
Error from server (NotFound): deployments.apps "alb-ingress-controller" not found
5.6) Установите AWS Load Balancer Controller одним из следующих способов:
HELM:
#Install the TargetGroupBinding custom resource definitions.
kubectl apply -k "github.com/aws/eks-charts/stable/aws-load-balancer-controller//crds?ref=master"
#Add the eks-charts repository.
helm repo add eks https://aws.github.io/eks-charts
# Install the AWS Load Balancer Controller using the command that corresponds to the Region that your cluster is in.
# For FARGATE !!!
helm upgrade -i aws-load-balancer-controller eks/aws-load-balancer-controller \
  --set clusterName=QA \
  --set serviceAccount.create=false \
  --set serviceAccount.name=aws-load-balancer-controller \
  --set region=us-west-2 \
  --set vpcId=<vpc-xxxxxxxx> \
  -n kube-system
# vpcId можно найти на странице кластера в AWS
5.7) Verify
kubectl get deployment -n kube-system aws-load-balancer-controller
NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
aws-load-balancer-controller   1/1     1            1           23m

























4.5) предоставления разрешений IAM модулю Fargate
eksctl utils associate-iam-oidc-provider --cluster QA --approve



4) generate kubeconfig
aws eks --region us-west-2 update-kubeconfig --name QA

kubectl get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.100.0.1   <none>        443/TCP   28m

5) API server endpoint
export KUBECONFIG=$KUBECONFIG:/opt/.kube/configs/qa.yml









