1# pre steps
uname -r
4.18.0-193.el8.x86_64
grep -E "CONFIG_EXT4_FS_SECURITY|CONFIG_EXT4_FS_POSIX_ACL" /boot/config-4.18.0-193.el8.x86_64


# change hostname
hostnamectl set-hostname dc

nano /etc/hosts
192.168.4.119  dc  dc.vko-simvol.lan

# check (DELETE if exist)
ps ax | egrep "samba|smbd|nmbd|winbindd"
smbd -b | grep "CONFIGFILE"
smbd -b | egrep "LOCKDIR|STATEDIR|CACHEDIR|PRIVATE_DIR"

#Remove an existing /etc/krb5.conf file:
rm /etc/krb5.conf -y

#Enable Required Repositories
yum -y install epel-release
yum -y install dnf-plugins-core

# 2 Install Dependency Packages
yum config-manager --set-enabled PowerTools
yum -y install docbook-style-xsl gcc gdb gnutls-devel gpgme-devel jansson-devel \
      keyutils-libs-devel krb5-workstation libacl-devel libaio-devel \
      libarchive-devel libattr-devel libblkid-devel libtasn1 libtasn1-tools \
      libxml2-devel libxslt lmdb-devel openldap-devel pam-devel perl \
      perl-ExtUtils-MakeMaker perl-Parse-Yapp popt-devel python3-cryptography \
      python3-dns python3-gpg python36-devel readline-devel rpcgen systemd-devel \
      tar zlib-devel wget dbus dbus-devel git
	  
	  
# REBOOT
reboot 

# 3 Download latest stable samba build
cd /opt
wget https://download.samba.org/pub/samba/stable/samba-4.13.2.tar.gz
tar -xzvf samba-4.13.2.tar.gz
cd samba-4.13.2/
./configure
###'configure' finished successfully (2m32.681s)
# make with 4 cores
make -j 4
#'build' finished successfully (32m20.012s)
make install
###'install' finished successfully (8m56.726s)
# 4. Set environment variable
nano /etc/profile.d/samba
PATH=/usr/local/samba/bin/:/usr/local/samba/sbin/:$PATH
export PATH
source /etc/profile.d/samba
## 5. Provisioning Samba Active Directory
ip a
# ens18
samba-tool domain provision --use-rfc2307 --realm=vko-simvol.lan --domain vko-simvol --adminpass='QWE!23wsx' --dns-backend=SAMBA_INTERNAL --server-role=dc --option="interfaces= lo ens18" --option="bind interfaces only=yes"
       


## 6. Configure the DNS Resolver
cat /etc/resolv.conf
# Generated by NetworkManager
search VKO-SIMVOL.LAN
nameserver 192.168.4.119
nameserver 192.168.4.1

##7. Start Samba Service
samba
ps -ef | grep samba

## 8. Verify Samba Service
testparm
smbclient --version
smbclient -L localhost -U%
and check if you get a proper reply with all the shared directories including sysvol and netlogon. 
The 'netlogon' and 'sysvol' shares are basic shares needed for Active Directory server operation.


## 9. Create Reverse Zone
#You can optionally add a reverse lookup zone.
#The reverse zone is directly live without restarting Samba or BIND.
samba-tool dns zonecreate 192.168.4.119 4.168.192.in-addr.arpa -U administrator
QWE!23wsx
##10. Configure Network Time Synchronization
https://www.golinuxcloud.com/samba-active-directory/#1_Prerequisites
yum -y install chrony
timedatectl
nano /etc/chrony.conf
systemctl enable chronyd
systemctl start chronyd
##11. Configuring Kerberos
In an AD, Kerberos is used to authenticate users, machines, and services. During the provisioning, Samba created a Kerberos configuration file for your DC. Copy this file to your operating system's Kerberos configuration. For example:
cp /usr/local/samba/private/krb5.conf /etc/krb5.conf
##12. Verifying DNS
##_ldapSRV-запись на основе tcp в домене:
host -t SRV _ldap._tcp.vko-simvol.lan.
_ldap._tcp.vko-simvol.lan has SRV record 0 100 389 dc.vko-simvol.lan.
## Запись _kerberosресурса SRV на основе UDP в домене:
host -t SRV _kerberos._udp.vko-simvol.lan.
_kerberos._udp.vko-simvol.lan has SRV record 0 100 88 dc.vko-simvol.lan.

##A Запись контроллера домена:
host -t A dc.vko-simvol.lan.
dc.vko-simvol.lan has address 192.168.4.119


##13. Verifying Kerberos
kinit Administrator
QWE!23wsx

##14. Configure Firewall
systemctl start firewalld
firewall-cmd --add-service={dns,ldap,ldaps,kerberos}
firewall-cmd --add-port={389/udp,135/tcp,135/udp,138/udp,138/tcp,137/tcp,137/udp,139/udp,139/tcp,445/tcp,445/udp,3268/udp,3268/tcp,3269/tcp,3269/udp,49152/tcp}

##15. Managing Samba AD Domain Controller
samba-tool user list
samba-tool group listmembers "Domain Admins"


16 CHECKS
where config file
smbd -b | grep "CONFIGFILE"
/usr/local/samba/etc/smb.conf
17
# list
samba-tool ou list
samba-tool ou create "OU=VKO,DC=vko-simvol,DC=lan"
samba-tool ou create "OU=Users,OU=VKO,DC=vko-simvol,DC=lan"
samba-tool ou create "OU=Service_users,OU=Users,OU=VKO,DC=vko-simvol,DC=lan"
samba-tool ou create "OU=Groups,OU=VKO,DC=vko-simvol,DC=lan"
samba-tool ou create "OU=Computers,OU=VKO,DC=vko-simvol,DC=lan"

# 18
go on windows
install rsat packages
add windows to domain (maybe need add some DNS )

# for computers
redircmp "OU=Computers,OU=VKO,DC=vko-simvol,DC=lan"
# for users
redirusr "OU=Users,OU=VKO,DC=vko-simvol,DC=lan"

19#
# delete password policy
samba-tool domain passwordsettings set --complexity=off
samba-tool domain passwordsettings set --history-length=0
samba-tool domain passwordsettings set --min-pwd-age=0
samba-tool domain passwordsettings set --max-pwd-age=0
samba-tool domain passwordsettings set --min-pwd-length=0








